<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Community Reports</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body, html { height: 100%; margin: 0; font-family: Arial, Helvetica, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 320px; right: 0; }
        #sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 320px; overflow: auto; background: #f9fafb; border-right: 1px solid #e6e7ea; padding: 16px; }
        .report-form label { display: block; margin-top: 8px; font-size: 0.9rem; }
        .report-form input, .report-form textarea, .report-form select { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }
        .btn { background: #2563eb; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .feed-item { border-bottom: 1px solid #eee; padding: 8px 0; }
    </style>
</head>

<body>
    <div id="sidebar">
        <h2>Report an incident</h2>
        <form id="reportForm" class="report-form">
            <label>Category
                <select id="category" required>
                    <option value="flood">Flood</option>
                    <option value="dust">Dust Storm</option>
                    <option value="fire">Fire</option>
                    <option value="crop_disease">Crop Disease</option>
                    <option value="road_block">Road Block</option>
                    <option value="other">Other</option>
                </select>
            </label>
            <label>Short title <input id="title" maxlength="80" placeholder="e.g., Flood near market" /></label>
            <label>Description <textarea id="description" rows="3" maxlength="600" placeholder="Describe briefly..."></textarea></label>
            <label>Severity <input id="severity" type="range" min="1" max="5" value="3" /></label>
            <label>Photo (optional) <input id="photo" type="file" accept="image/*" /></label>
            <label><input id="anon" type="checkbox" checked /> Post anonymously</label>
            <div style="margin-top:10px">
                <button class="btn" type="submit">Submit Report</button>
                <button id="useLocation" type="button" style="margin-left:8px">Use my location</button>
            </div>
            <small id="statusText" style="display:block;margin-top:8px;color:#666"></small>
        </form>

        <h3 style="margin-top:18px">Live feed</h3>
        <div id="feed"></div>
        <h4 style="margin-top:12px">Filters</h4>
        <label>Time window
            <select id="timeWindow">
                <option value="24">Last 24h</option>
                <option value="1">Last hour</option>
                <option value="168">Last 7d</option>
            </select>
        </label>
        <label>Category filter
            <select id="filterCategory">
                <option value="all">All</option>
                <option value="flood">Flood</option>
                <option value="dust">Dust Storm</option>
                <option value="fire">Fire</option>
                <option value="crop_disease">Crop Disease</option>
            </select>
        </label>
        <button id="applyFilters" class="btn" style="margin-top:8px">Apply</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        const markerCluster = L.markerClusterGroup();
        map.addLayer(markerCluster);

        function categoryColor(cat) {
            switch (cat) {
                case 'flood': return '#2563eb';
                case 'dust': return '#f59e0b';
                case 'fire': return '#ef4444';
                case 'crop_disease': return '#10b981';
                case 'road_block': return '#6b7280';
                default: return '#6366f1';
            }
        }

        function makeCircleIcon(category, severity) {
            const size = 20 + (severity - 1) * 4;
            const html = `<div style="
                width:${size}px;height:${size}px;border-radius:50%;
                background:${categoryColor(category)};
                display:flex;align-items:center;justify-content:center;
                color:white;font-size:12px;border:2px solid rgba(255,255,255,0.6)">
                ${severity}
            </div>`;
            return L.divIcon({ html, className: '', iconSize: [size, size], iconAnchor: [size / 2, size / 2] });
        }

        const socket = io();
        socket.on('connect', () => console.log('Socket connected'));
        socket.on('new-report', r => { addReportToMap(r, true); prependToFeed(r); });

        async function loadReports(filters = {}) {
            const q = new URLSearchParams(filters).toString();
            const res = await fetch('/api/reports?' + q);
            if (!res.ok) return console.error('Failed to load reports');
            const data = await res.json();
            markerCluster.clearLayers();
            data.forEach(addReportToMap);
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            data.slice(0, 50).forEach(prependToFeed);
        }

        function addReportToMap(r, highlight = false) {
            if (!r.location || !r.location.coordinates) return;
            const [lng, lat] = r.location.coordinates;
            const icon = makeCircleIcon(r.category, r.severity || 3);
            const marker = L.marker([lat, lng], { icon });
            const popupHtml = `
                <strong>${r.title || (r.category + ' report')}</strong><br/>
                <small>${new Date(r.createdAt).toLocaleString()}</small><br/>
                <div style="margin-top:6px">${r.description || ''}</div>
                ${r.images && r.images.length ? `<div style="margin-top:6px"><img src="${r.images[0]}" style="max-width:180px;max-height:120px" /></div>` : ''}
                <div style="margin-top:8px"><button onclick="upvote('${r._id}')">üëç ${r.upvotes || 0}</button></div>
            `;
            marker.bindPopup(popupHtml);
            markerCluster.addLayer(marker);
            if (highlight) marker.openPopup();
        }

        function prependToFeed(r) {
            const feed = document.getElementById('feed');
            const el = document.createElement('div');
            el.className = 'feed-item';
            el.innerHTML = `<strong>${r.title || r.category}</strong> <small>¬∑ ${timeAgo(new Date(r.createdAt))}</small>
                <div style="font-size:0.9em;color:#444">${r.description || ''}</div>`;
            feed.prepend(el);
        }

        function timeAgo(date) {
            const s = Math.floor((Date.now() - date) / 1000);
            if (s < 60) return `${s}s ago`;
            if (s < 3600) return `${Math.floor(s / 60)}m ago`;
            if (s < 86400) return `${Math.floor(s / 3600)}h ago`;
            return `${Math.floor(s / 86400)}d ago`;
        }

        const form = document.getElementById('reportForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem("token");
            if (!token) return alert('Please login first');

            const category = document.getElementById('category').value;
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const severity = Number(document.getElementById('severity').value);
            const anonymous = document.getElementById('anon').checked;
            const file = document.getElementById('photo').files[0];

            const payload = new FormData();
            payload.append('category', category);
            payload.append('title', title);
            payload.append('description', description);
            payload.append('severity', severity);
            payload.append('anonymous', anonymous);
            const center = map.getCenter();
            payload.append('lat', center.lat);
            payload.append('lng', center.lng);
            if (file) payload.append('photo', file);

            const statusText = document.getElementById('statusText');
            statusText.textContent = 'Submitting...';

            try {
                const res = await fetch('/api/report', {
                    method: 'POST',
                    headers: { "Authorization": "Bearer " + token },
                    body: payload
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Server error');

                statusText.textContent = 'Report submitted!';
                addReportToMap(data, true);
                prependToFeed(data);
                form.reset();
                setTimeout(() => statusText.textContent = '', 3000);

            } catch (err) {
                console.error(err);
                statusText.textContent = 'Error: ' + err.message;
            }
        });

        document.getElementById('useLocation').addEventListener('click', () => {
            if (!navigator.geolocation) return alert('Geolocation not supported');
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 14);
            }, err => alert('Location error: ' + err.message));
        });

        document.getElementById('applyFilters').addEventListener('click', () => {
            const timeWindow = document.getElementById('timeWindow').value;
            const category = document.getElementById('filterCategory').value;
            loadReports({ timeWindow, category });
        });

        window.upvote = async function (id) {
            const token = localStorage.getItem("token");
            if (!token) return alert('Please login first');
            await fetch('/api/report/' + id + '/upvote', {
                method: 'POST',
                headers: { "Authorization": "Bearer " + token }
            });
        };

        loadReports();
    </script>
</body>

</html>
