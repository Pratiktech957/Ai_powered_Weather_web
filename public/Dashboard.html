<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KisanMitra - Advanced Farmer Dashboard</title>
    <!-- Using UMD version of Chart.js that doesn't require modules -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #3a6186, #89253e);
            min-height: 100vh;
            color: #333;
            background-attachment: fixed;
            overflow-x: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .location-input {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .location-input input {
            padding: 0.8rem 1.2rem;
            border: 2px solid #ddd;
            border-radius: 50px;
            font-size: 1rem;
            width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .location-input input:focus {
            border-color: #27ae60;
            outline: none;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
        }

        .btn {
            background: linear-gradient(to right, #27ae60, #2ecc71);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .btn:hover {
            background: linear-gradient(to right, #219a52, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(39, 174, 96, 0.4);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.8rem;
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.25);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, #27ae60, #3498db, #9b59b6);
        }

        .card:hover {
            transform: translateY(-7px);
            box-shadow: 0 20px 45px rgba(0,0,0,0.2);
        }

        .card-title {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid rgba(52, 152, 219, 0.15);
        }

        .weather-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .temp-display {
            font-size: 3.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .weather-icon {
            font-size: 5rem;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1.2rem;
            margin-top: 1.5rem;
        }

        .detail-item {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(46, 204, 113, 0.1));
            padding: 1.2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border: 1px solid rgba(52, 152, 219, 0.15);
        }

        .detail-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        .detail-value {
            font-size: 1.7rem;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }

        .detail-label {
            color: #7f8c8d;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .forecast-container {
            display: flex;
            overflow-x: auto;
            gap: 1.5rem;
            padding: 1.2rem 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: #3498db #f1f1f1;
        }

        .forecast-container::-webkit-scrollbar {
            height: 8px;
        }

        .forecast-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .forecast-container::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
        }

        .forecast-item {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 1.2rem 1rem;
            border-radius: 15px;
            min-width: 140px;
            text-align: center;
            flex-shrink: 0;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s;
        }

        .forecast-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }

        .aqi-indicator {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            margin-top: 0.5rem;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .aqi-good { background: linear-gradient(to right, #27ae60, #2ecc71); }
        .aqi-moderate { background: linear-gradient(to right, #f39c12, #f1c40f); }
        .aqi-poor { background: linear-gradient(to right, #e74c3c, #c0392b); }

        .recommendation {
            background: linear-gradient(135deg, #a8e6cf, #81c784);
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1.2rem 0;
            color: #2c3e50;
            border-left: 5px solid #27ae60;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .alert {
            background: linear-gradient(135deg, #ffcdd2, #f8bbd9);
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1.2rem 0;
            color: #c62828;
            border-left: 5px solid #e74c3c;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .loading {
            text-align: center;
            padding: 2.5rem;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-top-color: #3498db;
            border-radius: 50%;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .chart-container {
            position: relative;
            height: 320px;
            margin-top: 1.5rem;
        }

        .crop-suggestion {
            background: rgba(46, 204, 113, 0.1);
            padding: 1.2rem;
            border-radius: 12px;
            margin: 0.8rem 0;
            border-left: 4px solid #2ecc71;
            transition: all 0.3s;
        }

        .crop-suggestion:hover {
            transform: translateX(5px);
            background: rgba(46, 204, 113, 0.15);
        }

        .irrigation-schedule {
            background: rgba(52, 152, 219, 0.1);
            padding: 1.2rem;
            border-radius: 12px;
            margin: 0.8rem 0;
            border-left: 4px solid #3498db;
            transition: all 0.3s;
        }

        .irrigation-schedule:hover {
            transform: translateX(5px);
            background: rgba(52, 152, 219, 0.15);
        }

        .market-price {
            display: flex;
            justify-content: space-between;
            background: rgba(155, 89, 182, 0.1);
            padding: 1.2rem;
            border-radius: 12px;
            margin: 0.8rem 0;
            border-left: 4px solid #9b59b6;
            transition: all 0.3s;
        }

        .market-price:hover {
            transform: translateX(5px);
            background: rgba(155, 89, 182, 0.15);
        }

        .price-trend {
            color: #27ae60;
            font-weight: 700;
        }

        .price-trend.down {
            color: #e74c3c;
        }

        .scheme-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.2rem;
            border-radius: 12px;
            margin: 0.8rem 0;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .scheme-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1.2rem;
            border-radius: 12px;
            margin: 1.2rem 0;
            border-left: 4px solid #e74c3c;
        }

        .retry-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 0.8rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .retry-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { 
            background: #27ae60;
            box-shadow: 0 0 8px #27ae60;
        }
        .status-offline { 
            background: #e74c3c;
            box-shadow: 0 0 8px #e74c3c;
        }
        .status-loading { 
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { 
                opacity: 1; 
                box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(243, 156, 18, 0);
            }
            100% { 
                opacity: 0.5; 
                box-shadow: 0 0 0 0 rgba(243, 156, 18, 0);
            }
        }

        .notification-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .sensor-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .sensor-item {
            text-align: center;
            padding: 1rem;
            background: rgba(236, 240, 241, 0.5);
            border-radius: 10px;
        }

        .sensor-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .progress-bar {
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #27ae60, #2ecc71);
        }

        .tab-container {
            margin-top: 1.5rem;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            position: relative;
        }

        .tab.active {
            color: #2c3e50;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #27ae60;
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .floating-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.5s ease;
        }

        .floating-notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 1.5rem;
        }

        .notification-content {
            flex: 1;
        }

        .close-notification {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                padding: 1.5rem;
            }
            
            .card {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .location-input {
                flex-direction: column;
                align-items: stretch;
            }
            
            .location-input input {
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .card-title {
                font-size: 1.3rem;
            }
            
            .temp-display {
                font-size: 3rem;
            }
            
            .weather-icon {
                font-size: 4rem;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .logo {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            .weather-details {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <div class="logo">🌾</div>
            <div>
                <h1>KisanMitra - Advanced Farmer Dashboard</h1>
                <p>Real-time weather insights and AI-powered farming recommendations</p>
            </div>
        </div>
        
        <div class="location-input">
            <input type="text" id="locationInput" placeholder="Enter your city name (e.g., Delhi, Mumbai)" value="Delhi">
            <button class="btn" onclick="fetchWeatherData()" id="weatherBtn">
                <span>🔍</span> Get Weather Data
            </button>
            <button class="btn" onclick="getCurrentLocation()" id="locationBtn" style="background: linear-gradient(to right, #3498db, #2980b9);">
                <span>📍</span> Use Current Location
            </button>
        </div>
        <div style="margin-top: 1rem; font-size: 0.9rem; display: flex; align-items: center;">
            <span class="status-indicator status-loading" id="apiStatus"></span>
            <span id="statusText">Checking API status...</span>
        </div>
    </div>

    <div class="dashboard">
        <!-- Weather & AQI Section -->
        <div class="card" style="grid-column: span 2;">
            <div class="card-title"></div>
            <div id="weatherContent" class="loading">Enter location and click "Get Weather Data" to start</div>
        </div>

        <!-- Forecast Chart -->
        <div class="card">
            <div class="card-title">📊 7-Day Forecast</div>
            <div class="chart-container">
                <canvas id="forecastChart"></canvas>
            </div>
        </div>

        <!-- Crop Recommendations -->
        <div class="card">
            <div class="card-title">🌱 AI Crop Recommendations</div>
            <div id="cropRecommendations" class="loading">Weather data needed for recommendations</div>
        </div>

        <!-- Soil & Irrigation -->
        <div class="card">
            <div class="card-title">💧 Irrigation & Soil Guide</div>
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('irrigation')">Irrigation</div>
                    <div class="tab" onclick="switchTab('soil')">Soil Health</div>
                    <div class="tab" onclick="switchTab('sensors')">Field Sensors</div>
                </div>
                
                <div class="tab-content active" id="irrigationTab">
                    <div id="irrigationGuide" class="loading">Calculating irrigation needs...</div>
                </div>
                
                <div class="tab-content" id="soilTab">
                    <div id="soilHealth" class="loading">Loading soil health data...</div>
                </div>
                
                <div class="tab-content" id="sensorsTab">
                    <div id="sensorData" class="loading">Connecting to field sensors...</div>
                </div>
            </div>
        </div>

        <!-- Market Prices -->
        <div class="card">
            <div class="card-title">💰 Market Price Updates</div>
            <div id="marketPrices">
                <div class="market-price">
                    <span>Wheat (₹/quintal)</span>
                    <span class="price-trend">₹2,150 ↗️</span>
                </div>
                <div class="market-price">
                    <span>Rice (₹/quintal)</span>
                    <span class="price-trend down">₹1,950 ↘️</span>
                </div>
                <div class="market-price">
                    <span>Sugarcane (₹/quintal)</span>
                    <span class="price-trend">₹380 ↗️</span>
                </div>
                <div class="market-price">
                    <span>Cotton (₹/quintal)</span>
                    <span class="price-trend">₹5,800 →</span>
                </div>
            </div>
        </div>

        <!-- Pest & Disease Alerts -->
        <div class="card">
            <div class="card-title">🐛 Pest & Disease Alerts</div>
            <div id="pestAlerts" class="loading">No current alerts</div>
        </div>

        <!-- Government Schemes -->
        <div class="card">
            <div class="card-title">🏛️ Government Schemes</div>
            <div class="scheme-card">
                <h3>PM-KISAN Scheme</h3>
                <p>₹6,000 annual income support for farmers</p>
            </div>
            <div class="scheme-card">
                <h3>Crop Insurance</h3>
                <p>Pradhan Mantri Fasal Bima Yojana - Protect your crops</p>
            </div>
            <div class="scheme-card">
                <h3>Soil Health Card</h3>
                <p>Free soil testing and nutrient recommendations</p>
            </div>
        </div>
    </div>
    
    <div class="floating-notification" id="notification">
        <div class="notification-icon">🔔</div>
        <div class="notification-content" id="notificationContent">New weather update available!</div>
        <button class="close-notification" onclick="hideNotification()">×</button>
    </div>

    <script>
        const CONFIG = {
           
            RATE_LIMIT_DELAY: 1500,
            MAX_RETRIES: 4,
            TIMEOUT: 12000,
            FALLBACK_CITIES: ["Delhi", "Mumbai", "Bangalore", "Kolkata", "Chennai"]
        };

        let state = {
            forecastChart: null,
            currentWeatherData: null,
            lastRequestTime: 0,
            apiCallCount: 0,
            isLoading: false,
            activeTab: "irrigation",
            notificationTimeout: null,
            offlineMode: false
        };

        const utils = {
            delay: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
            
            rateLimitedFetch: async (url, options = {}) => {
                const now = Date.now();
                const timeSinceLastRequest = now - state.lastRequestTime;
                
                if (timeSinceLastRequest < CONFIG.RATE_LIMIT_DELAY) {
                    await utils.delay(CONFIG.RATE_LIMIT_DELAY - timeSinceLastRequest);
                }
                
                state.lastRequestTime = Date.now();
                state.apiCallCount++;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            },

            retryFetch: async (url, options = {}, retries = CONFIG.MAX_RETRIES) => {
                let lastError;
                
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await utils.rateLimitedFetch(url, options);
                        return response;
                    } catch (error) {
                        lastError = error;
                        
                        if (error.name === 'AbortError') {
                            console.warn(`Request timed out (attempt ${i+1}/${retries})`);
                        } else if (error.message.includes('429')) {
                            console.warn(`Rate limited (attempt ${i+1}/${retries})`);
                        } else {
                            console.error(`Fetch error (attempt ${i+1}/${retries}):`, error);
                        }
                        
                        if (i === retries - 1) break;
                        
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await utils.delay(delay);
                    }
                }
                
                throw lastError;
            },

            updateStatus: (status, text) => {
                const statusElement = document.getElementById('apiStatus');
                const textElement = document.getElementById('statusText');
                
                statusElement.className = `status-indicator status-${status}`;
                textElement.textContent = text;
            },

            showError: (elementId, message, showRetry = false) => {
                const element = document.getElementById(elementId);
                const retryButton = showRetry ? 
                    `<button class="retry-btn" onclick="fetchWeatherData()">🔄 Retry</button>` : '';
                
                element.innerHTML = `
                    <div class="error">
                        ❌ ${message}
                        ${retryButton}
                    </div>
                `;
            },
            
            showNotification: (message) => {
                const notification = document.getElementById('notification');
                const content = document.getElementById('notificationContent');
                
                content.textContent = message;
                notification.classList.add('show');
                
                if (state.notificationTimeout) {
                    clearTimeout(state.notificationTimeout);
                }
                
                state.notificationTimeout = setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            },
            
            hideNotification: () => {
                const notification = document.getElementById('notification');
                notification.classList.remove('show');
            },
            
            simulateOfflineData: (location) => {
                const temp = 25 + Math.floor(Math.random() * 15);
                const humidity = 40 + Math.floor(Math.random() * 40);
                
                const fakeData = {
                    name: location,
                    sys: { country: "IN", sunrise: Date.now()/1000 - 3600, sunset: Date.now()/1000 + 3600*8 },
                    weather: [{ main: "Clear", description: "clear sky" }],
                    main: {
                        temp: temp,
                        feels_like: temp - 2,
                        humidity: humidity,
                        pressure: 1015
                    },
                    wind: { speed: 3.5 },
                    visibility: 10000
                };
                
                displayWeatherData(fakeData);
                generateFakeForecast();
                displayDefaultRecommendations(fakeData);
                generateAdvancedIrrigationAdvice(fakeData);
                
                utils.updateStatus('offline', 'Offline mode - using simulated data');
                utils.showNotification("⚠️ Working in offline mode with simulated data");
            }
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`${tabId}Tab`).classList.add('active');
            
            event.target.classList.add('active');
            state.activeTab = tabId;
            
            if (tabId === 'soil' && document.getElementById('soilHealth').classList.contains('loading')) {
                setTimeout(loadSoilHealthData, 300);
            } else if (tabId === 'sensors' && document.getElementById('sensorData').classList.contains('loading')) {
                setTimeout(loadSensorData, 300);
            }
        }

        function getCurrentLocation() {
            const btn = document.getElementById('locationBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>⏳</span> Getting location...';
            
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by this browser.");
                btn.disabled = false;
                btn.innerHTML = '<span>📍</span> Use Current Location';
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            };

            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    fetchWeatherByCoords(lat, lon);
                    btn.disabled = false;
                    btn.innerHTML = '<span>📍</span> Use Current Location';
                },
                error => {
                    let message = "Unable to get location. ";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += "Permission denied by user.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += "Location information unavailable.";
                            break;
                        case error.TIMEOUT:
                            message += "Location request timed out.";
                            break;
                        default:
                            message += "Unknown error occurred.";
                    }
                    
                    utils.showNotification("⚠️ " + message);
                    btn.disabled = false;
                    btn.innerHTML = '<span>📍</span> Use Current Location';
                    
                    const fallbackCity = CONFIG.FALLBACK_CITIES[Math.floor(Math.random() * CONFIG.FALLBACK_CITIES.length)];
                    document.getElementById('locationInput').value = fallbackCity;
                    fetchWeatherData();
                },
                options
            );
        }

        async function fetchWeatherByCoords(lat, lon) {
            try {
                utils.updateStatus('loading', 'Getting weather by coordinates...');
                
                const response = await utils.retryFetch(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${CONFIG.OPENWEATHER_API}&units=metric`
                );
                
                const data = await response.json();
                
                if (data.cod === 200) {
                    document.getElementById('locationInput').value = data.name;
                    displayWeatherData(data);
                    await fetchForecastData(data.name);
                    await fetchAIRecommendations(data);
                    utils.updateStatus('online', 'All systems operational');
                    utils.showNotification("✅ Weather data updated successfully");
                } else {
                    throw new Error(data.message || 'Failed to fetch weather data');
                }
            } catch (error) {
                console.error('Error fetching weather by coordinates:', error);
                utils.updateStatus('offline', 'Weather API error');
                utils.showError('weatherContent', `Failed to get weather: ${error.message}`, true);
                utils.showNotification("⚠️ Error fetching weather data");
                
                state.offlineMode = true;
                utils.simulateOfflineData("Current Location");
            }
        }

        async function fetchWeatherData() {
            if (state.isLoading) return;
            
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                utils.showNotification("⚠️ Please enter a city name");
                return;
            }

            const btn = document.getElementById('weatherBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>🔄</span> Loading...';
            state.isLoading = true;
            state.offlineMode = false;

            try {
                utils.updateStatus('loading', 'Fetching weather data...');
                document.getElementById('weatherContent').innerHTML = '<div class="loading">Loading weather data...</div>';

                const weatherResponse = await utils.retryFetch(
                    `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(location)}&appid=${CONFIG.OPENWEATHER_API}&units=metric`
                );
                
                const weatherData = await weatherResponse.json();

                if (weatherData.cod !== 200) {
                    throw new Error(weatherData.message || 'Weather data not found');
                }

                state.currentWeatherData = weatherData;
                displayWeatherData(weatherData);
                
                await Promise.allSettled([
                    fetchForecastData(location),
                    fetchAIRecommendations(weatherData)
                ]);

                utils.updateStatus('online', ` ${state.apiCallCount} | Last updated: ${new Date().toLocaleTimeString()}`);

            } catch (error) {
                console.error('Error fetching weather data:', error);
                utils.updateStatus('offline', 'Weather API error');
                
                let errorMessage = 'Failed to fetch weather data';
                if (error.message.includes('timeout')) {
                    errorMessage = 'Request timed out. Please try again.';
                } else if (error.message.includes('429')) {
                    errorMessage = 'Too many requests. Please wait a moment.';
                } else if (error.message.includes('not found')) {
                    errorMessage = 'City not found. Please check spelling.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error. Check your connection.';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'CORS issue detected. Try different location.';
                }
                
                utils.showError('weatherContent', errorMessage, true);
                utils.showNotification("⚠️ " + errorMessage);
                
                state.offlineMode = true;
                utils.simulateOfflineData(location);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>🔍</span> Get Weather Data';
                state.isLoading = false;
            }
        }

        function displayWeatherData(data) {
            try {
                const weatherIcon = getWeatherIcon(data.weather[0].main);
                const aqi = Math.floor(Math.random() * 150) + 50;
                const aqiCategory = getAQICategory(aqi);
                const sunrise = new Date(data.sys.sunrise * 1000).toLocaleTimeString();
                const sunset = new Date(data.sys.sunset * 1000).toLocaleTimeString();

                const html = `
                    <div class="weather-main">
                        <div>
                            <div class="temp-display">${Math.round(data.main.temp)}°C</div>
                            <div style="font-size: 1.3rem; color: #7f8c8d; margin-top: 0.5rem;">
                                ${data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1)}
                            </div>
                            <div style="margin-top: 0.8rem; font-size: 1.1rem;">
                                📍 ${data.name}, ${data.sys.country}
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 1rem; color: #95a5a6;">
                                Feels like ${Math.round(data.main.feels_like)}°C
                            </div>
                        </div>
                        <div class="weather-icon">${weatherIcon}</div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="detail-item">
                            <div class="detail-value">${data.main.humidity}%</div>
                            <div class="detail-label">Humidity</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${data.wind.speed} m/s</div>
                            <div class="detail-label">Wind Speed</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${data.main.pressure} hPa</div>
                            <div class="detail-label">Pressure</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${Math.round((data.visibility || 10000) / 1000)} km</div>
                            <div class="detail-label">Visibility</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">🌅 ${sunrise}</div>
                            <div class="detail-label">Sunrise</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">🌇 ${sunset}</div>
                            <div class="detail-label">Sunset</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; align-items: center;">
                        <strong style="margin-right: 10px;">Air Quality Index:</strong>
                        <span class="aqi-indicator aqi-${aqiCategory.class}">${aqi} - ${aqiCategory.label}</span>
                    </div>
                `;

                document.getElementById('weatherContent').innerHTML = html;
            } catch (error) {
                console.error('Error displaying weather data:', error);
                utils.showError('weatherContent', 'Failed to display weather data');
            }
        }

        async function fetchForecastData(location) {
            try {
                const response = await utils.retryFetch(
                    `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(location)}&appid=${CONFIG.OPENWEATHER_API}&units=metric`
                );
                
                const data = await response.json();

                if (data.cod === "200") {
                    displayForecastChart(data);
                } else {
                    throw new Error(data.message || 'Forecast data not available');
                }
            } catch (error) {
                console.error('Error fetching forecast:', error);
                document.getElementById('forecastChart').parentNode.innerHTML = `
                    <div class="error">Unable to load forecast data: ${error.message}</div>
                `;
                
                if (state.offlineMode) {
                    generateFakeForecast();
                }
            }
        }

        function generateFakeForecast() {
            const labels = [];
            const temps = [];
            const rainfall = [];
            
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(today.getDate() + i);
                labels.push(date.toLocaleDateString('en-IN', { weekday: 'short', day: 'numeric' }));
                
                const baseTemp = 22 + Math.sin(i * 0.8) * 8;
                temps.push(Math.round(baseTemp + Math.random() * 4 - 2));
                
                rainfall.push(Math.round(Math.random() * 15));
            }
            
            displayForecastChart({ labels, temps, rainfall });
        }

        function displayForecastChart(data) {
            const chartCanvas = document.getElementById('forecastChart');
            if (!chartCanvas) return;
            
            try {
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.js library not loaded');
                }
                
                if (state.forecastChart) {
                    state.forecastChart.destroy();
                }

                let labels, temps, rainfall;
                
                if (data.list) {
                    const dailyData = {};
                    data.list.forEach(item => {
                        const date = new Date(item.dt * 1000).toLocaleDateString('en-IN', { 
                            month: 'short', 
                            day: 'numeric' 
                        });
                        if (!dailyData[date]) {
                            dailyData[date] = {
                                temps: [],
                                humidity: [],
                                rain: 0
                            };
                        }
                        dailyData[date].temps.push(item.main.temp);
                        if (item.rain && item.rain['3h']) {
                            dailyData[date].rain += item.rain['3h'];
                        }
                    });

                    labels = Object.keys(dailyData).slice(0, 7);
                    temps = labels.map(date => {
                        const temps = dailyData[date].temps;
                        return Math.round(temps.reduce((a, b) => a + b, 0) / temps.length);
                    });
                    rainfall = labels.map(date => Math.round(dailyData[date].rain * 10) / 10);
                } else {
                    labels = data.labels;
                    temps = data.temps;
                    rainfall = data.rainfall;
                }

                const ctx = chartCanvas.getContext('2d');
                state.forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Temperature (°C)',
                            data: temps,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true,
                            pointRadius: 5,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#e74c3c',
                            pointBorderWidth: 2
                        }, {
                            label: 'Rainfall (mm)',
                            data: rainfall,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            type: 'bar',
                            yAxisID: 'y1',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.85)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: false
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 13,
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)',
                                    font: {
                                        size: 13,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Rainfall (mm)',
                                    font: {
                                        size: 13,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating forecast chart:', error);
                chartCanvas.parentNode.innerHTML = `
                    <div class="error">
                        Unable to display forecast chart: ${error.message}
                    </div>
                `;
            }
        }

        async function fetchAIRecommendations(weatherData) {
            try {
                const prompt = createDetailedPrompt(weatherData);
                
                const response = await utils.retryFetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${CONFIG.GEMINI_API}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 1024
                            },
                            safetySettings: [
                                {
                                    category: "HARM_CATEGORY_HARASSMENT",
                                    threshold: "BLOCK_MEDIUM_AND_ABOVE"
                                }
                            ]
                        })
                    }
                );

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    displayAIRecommendations(aiResponse, weatherData);
                } else {
                    throw new Error('No AI response received');
                }
            } catch (error) {
                console.error('Error fetching AI recommendations:', error);
                displayDefaultRecommendations(weatherData);
                utils.showNotification("⚠️ Using fallback recommendations");
            }
        }

        function createDetailedPrompt(weatherData) {
            const season = getCurrentSeason();
            const month = new Date().toLocaleString('default', { month: 'long' });
            
            return `As an expert agricultural advisor for Indian farmers, provide practical farming recommendations in Hinglish (mix of Hindi and English) based on the following weather conditions:

**Location:** ${weatherData.name}, ${weatherData.sys.country}
**Current Temperature:** ${Math.round(weatherData.main.temp)}°C (Feels like: ${Math.round(weatherData.main.feels_like)}°C)
**Humidity:** ${weatherData.main.humidity}%
**Weather Condition:** ${weatherData.weather[0].description}
**Wind Speed:** ${weatherData.wind.speed} m/s
**Season:** ${season} (${month})

**Provide recommendations in this structured format:**
1. **🌾 Crop Recommendations (फसल सुझाव):** 
   - List 3-5 suitable crops with Hindi names
   - Include planting timing guidance

2. **💧 Irrigation Advice (सिंचाई सलाह):** 
   - Frequency based on current conditions
   - Best times for watering
   - Water conservation tips

3. **🛡️ Crop Protection (फसल सुरक्षा):**
   - Pest/disease alerts specific to current weather
   - Preventive measures
   - Organic treatment options

4. **🌱 Soil Management (मिट्टी प्रबंधन):**
   - Soil preparation tips
   - Nutrient management
   - Cover cropping suggestions

5. **⚠️ Weather Alerts (मौसम चेतावनी):**
   - Any immediate concerns
   - Protective measures for crops
   - Short-term forecast impact

**Important:**
- Use bullet points with emojis for readability
- Mix Hindi terms with English explanations (Hinglish)
- Prioritize cost-effective and sustainable methods
- Include traditional Indian farming wisdom where applicable
- Keep recommendations practical and actionable`;
        }

        function displayAIRecommendations(aiResponse, weatherData) {
            const formattedResponse = aiResponse
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/(\d+\.)\s/g, '<br><strong>$1</strong> ')
                .replace(/- /g, '• ')
                .replace(/\n/g, '<br>')
                .replace(/🌾 Crop Recommendations/g, '<div style="font-size:1.2rem; color:#27ae60; margin:15px 0 8px 0;">🌾 Crop Recommendations</div>')
                .replace(/💧 Irrigation Advice/g, '<div style="font-size:1.2rem; color:#3498db; margin:15px 0 8px 0;">💧 Irrigation Advice</div>')
                .replace(/🛡️ Crop Protection/g, '<div style="font-size:1.2rem; color:#e74c3c; margin:15px 0 8px 0;">🛡️ Crop Protection</div>')
                .replace(/🌱 Soil Management/g, '<div style="font-size:1.2rem; color:#9b59b6; margin:15px 0 8px 0;">🌱 Soil Management</div>')
                .replace(/⚠️ Weather Alerts/g, '<div style="font-size:1.2rem; color:#f39c12; margin:15px 0 8px 0;">⚠️ Weather Alerts</div>');

            document.getElementById('cropRecommendations').innerHTML = `
                <div class="recommendation">
                    <h3>🤖 AI-Powered Farming Recommendations</h3>
                    <div style="margin-top: 1.2rem; line-height: 1.7; font-size: 1.05rem;">
                        ${formattedResponse}
                    </div>
                    <div style="margin-top: 1.2rem; font-size: 0.9rem; color: #7f8c8d; border-top: 1px solid #ecf0f1; padding-top: 0.8rem;">
                        💡 Based on current weather conditions in ${weatherData.name} at ${new Date().toLocaleTimeString()}
                    </div>
                </div>
            `;

            const irrigationAdvice = generateAdvancedIrrigationAdvice(weatherData);
            document.getElementById('irrigationGuide').innerHTML = irrigationAdvice;
            
            loadPestAlerts(weatherData);
        }

        function displayDefaultRecommendations(weatherData) {
            const temp = weatherData.main.temp;
            const humidity = weatherData.main.humidity;
            const season = getCurrentSeason();
            const windSpeed = weatherData.wind.speed;

            let recommendations = '<h3>🌾 Smart Farming Recommendations</h3>';
            let alerts = '';

            if (temp > 35) {
                recommendations += `
                    <div class="crop-suggestion">
                        🔥 <strong>High Temperature Alert (${Math.round(temp)}°C)</strong><br>
                        • Heat-resistant crops: Sorghum (ज्वार), Pearl Millet (बाजरा), Cotton (कपास)<br>
                        • Provide shade nets for sensitive crops<br>
                        • Increase irrigation frequency - water in early morning and evening<br>
                        • Apply mulch to conserve soil moisture
                    </div>`;
                alerts += `<div class="alert">⚠️ Extreme heat warning! Increase water supply and provide crop protection from heat stress.</div>`;
            } else if (temp < 10) {
                recommendations += `
                    <div class="crop-suggestion">
                        ❄️ <strong>Cold Weather Guidance (${Math.round(temp)}°C)</strong><br>
                        • Suitable for: Wheat (गेहूं), Mustard (सरसों), Gram (चना)<br>
                        • Protect young plants from frost with covers<br>
                        • Reduce irrigation frequency to prevent freezing<br>
                        • Use organic compost to maintain soil temperature
                    </div>`;
                alerts += `<div class="alert">🧊 Frost warning! Protect sensitive crops with thermal covers or straw mulch.</div>`;
            }

            if (humidity > 80) {
                recommendations += `
                    <div class="crop-suggestion">
                        🌧️ <strong>High Humidity (${humidity}%)</strong><br>
                        • Ideal for: Rice (धान), Sugarcane (गन्ना), Taro (अरबी)<br>
                        • Monitor for fungal diseases like blast in rice<br>
                        • Ensure proper field drainage<br>
                        • Space plants for better air circulation
                    </div>`;
                alerts += `<div class="alert">🍄 High humidity detected. Apply neem-based fungicide as preventive measure.</div>`;
            } else if (humidity < 40) {
                recommendations += `
                    <div class="crop-suggestion">
                        🏜️ <strong>Low Humidity (${humidity}%)</strong><br>
                        • Increase mulching to retain soil moisture<br>
                        • More frequent but light irrigation<br>
                        • Consider drought-resistant varieties: Millets (बाजरा), Sorghum (ज्वार)<br>
                        • Use drip irrigation for water efficiency
                    </div>`;
            }

            if (windSpeed > 10) {
                alerts += `<div class="alert">💨 High wind alert (${windSpeed} m/s)! Provide support to tall crops and check for damage after wind subsides.</div>`;
            }

            const seasonalAdvice = getSeasonalAdvice(season, weatherData);
            recommendations += seasonalAdvice;

            document.getElementById('cropRecommendations').innerHTML = recommendations + alerts;

            const irrigationAdvice = generateAdvancedIrrigationAdvice(weatherData);
            document.getElementById('irrigationGuide').innerHTML = irrigationAdvice;
            
            loadPestAlerts(weatherData);
        }

        function generateAdvancedIrrigationAdvice(weatherData) {
            const temp = weatherData.main.temp;
            const humidity = weatherData.main.humidity;
            const windSpeed = weatherData.wind.speed;
            const pressure = weatherData.main.pressure;

            let etRate = 'Medium';
            let waterNeed = 'Normal';
            
            if (temp > 30 && humidity < 60 && windSpeed > 5) {
                etRate = 'High';
                waterNeed = 'Increased (30-40% more)';
            } else if (temp < 20 && humidity > 70) {
                etRate = 'Low';
                waterNeed = 'Reduced (20-30% less)';
            }

            let soilMoisture = 'Medium';
            if (humidity > 75 && temp < 25) {
                soilMoisture = 'High';
            } else if (humidity < 50 && temp > 30) {
                soilMoisture = 'Low';
            }

            let schedule = '';
            let timing = '';
            
            if (temp > 35) {
                schedule = 'Twice daily - Early morning (5-7 AM) and Evening (6-8 PM)';
                timing = 'Avoid midday irrigation to prevent leaf burning and water loss';
            } else if (temp < 15) {
                schedule = 'Every 2-3 days during warm hours (10 AM - 2 PM)';
                timing = 'Avoid evening irrigation to prevent freezing damage';
            } else {
                schedule = 'Once daily in evening (6-8 PM)';
                timing = 'Morning irrigation acceptable if evening not possible';
            }

            return `
                <div style="margin-bottom: 1rem;">
                    <h3>💧 Smart Irrigation Guide</h3>
                </div>
                
                <div class="irrigation-schedule">
                    <strong>📊 Current Conditions Assessment:</strong><br>
                    • Evapotranspiration Rate: <span style="color: ${etRate === 'High' ? '#e74c3c' : etRate === 'Low' ? '#27ae60' : '#f39c12'}; font-weight:700;">${etRate}</span><br>
                    • Estimated Soil Moisture: <span style="color: ${soilMoisture === 'High' ? '#3498db' : soilMoisture === 'Low' ? '#e74c3c' : '#27ae60'}; font-weight:700;">${soilMoisture}</span><br>
                    • Water Requirement: <strong style="color:#2c3e50;">${waterNeed}</strong>
                </div>

                <div class="irrigation-schedule">
                    <strong>⏰ Recommended Schedule:</strong><br>
                    ${schedule}<br><br>
                    <strong>💡 Best Timing:</strong><br>
                    ${timing}
                </div>

                <div class="irrigation-schedule">
                    <strong>🌱 Water Conservation Tips:</strong><br>
                    • Use drip irrigation or soaker hoses for 50-70% water savings<br>
                    • Apply 3-4 inch layer of organic mulch (straw, leaves)<br>
                    • Implement rainwater harvesting techniques<br>
                    • Group plants by water needs (hydrozoning)<br>
                    • Check soil moisture 2-3 inches deep before watering
                </div>
            `;
        }

        function loadSoilHealthData() {
            const ph = (6.5 + Math.random() * 1.5).toFixed(1);
            const nitrogen = (45 + Math.random() * 30).toFixed(0);
            const phosphorus = (25 + Math.random() * 20).toFixed(0);
            const potassium = (150 + Math.random() * 100).toFixed(0);
            
            const soilHealthHtml = `
                <div style="margin-bottom: 1.2rem;">
                    <h3>🌱 Soil Health Analysis</h3>
                </div>
                
                <div class="sensor-data">
                    <div class="sensor-item">
                        <div>pH Level</div>
                        <div class="sensor-value">${ph}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(ph-5)*20}%"></div>
                        </div>
                        <div>${ph < 6 ? 'Acidic' : ph > 7.5 ? 'Alkaline' : 'Optimal'}</div>
                    </div>
                    
                    <div class="sensor-item">
                        <div>Nitrogen (kg/ha)</div>
                        <div class="sensor-value">${nitrogen}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${nitrogen/100*100}%"></div>
                        </div>
                        <div>${nitrogen < 40 ? 'Low' : nitrogen > 70 ? 'High' : 'Optimal'}</div>
                    </div>
                    
                    <div class="sensor-item">
                        <div>Phosphorus (kg/ha)</div>
                        <div class="sensor-value">${phosphorus}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${phosphorus/50*100}%"></div>
                        </div>
                        <div>${phosphorus < 20 ? 'Low' : phosphorus > 40 ? 'High' : 'Optimal'}</div>
                    </div>
                    
                    <div class="sensor-item">
                        <div>Potassium (kg/ha)</div>
                        <div class="sensor-value">${potassium}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${potassium/300*100}%"></div>
                        </div>
                        <div>${potassium < 150 ? 'Low' : potassium > 250 ? 'High' : 'Optimal'}</div>
                    </div>
                </div>
                
                <div class="irrigation-schedule" style="margin-top: 1.5rem;">
                    <strong>📝 Recommendations:</strong><br>
                    • ${ph < 6 ? 'Apply lime to raise pH' : ph > 7.5 ? 'Add sulfur to lower pH' : 'pH is optimal'}<br>
                    • ${nitrogen < 40 ? 'Apply nitrogen-rich fertilizer' : nitrogen > 70 ? 'Reduce nitrogen application' : 'Nitrogen levels adequate'}<br>
                    • Test soil every 3 months for optimal nutrient management
                </div>
            `;
            
            document.getElementById('soilHealth').innerHTML = soilHealthHtml;
        }

        function loadSensorData() {
            const moisture = (40 + Math.random() * 50).toFixed(0);
            const temperature = (25 + Math.random() * 15).toFixed(0);
            const light = (60 + Math.random() * 40).toFixed(0);
            
            const sensorHtml = `
                <div style="margin-bottom: 1.2rem;">
                    <h3>📡 Real-time Field Sensors</h3>
                </div>
                
                <div class="sensor-data">
                    <div class="sensor-item">
                        <div>Soil Moisture</div>
                        <div class="sensor-value">${moisture}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${moisture}%"></div>
                        </div>
                        <div>${moisture < 40 ? 'Irrigation needed' : moisture > 80 ? 'Saturated' : 'Optimal'}</div>
                    </div>
                    
                    <div class="sensor-item">
                        <div>Soil Temperature</div>
                        <div class="sensor-value">${temperature}°C</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(temperature/50)*100}%"></div>
                        </div>
                        <div>${temperature < 15 ? 'Low' : temperature > 35 ? 'High' : 'Optimal'}</div>
                    </div>
                    
                    <div class="sensor-item">
                        <div>Light Intensity</div>
                        <div class="sensor-value">${light}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${light}%"></div>
                        </div>
                        <div>${light < 50 ? 'Low light' : 'Adequate light'}</div>
                    </div>
                </div>
                
                <div class="irrigation-schedule" style="margin-top: 1.5rem;">
                    <strong>🔔 Sensor Alerts:</strong><br>
                    • ${moisture < 40 ? 'Soil moisture low - irrigation recommended' : moisture > 80 ? 'Soil saturated - drainage needed' : 'Moisture levels normal'}<br>
                    • Last updated: ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            document.getElementById('sensorData').innerHTML = sensorHtml;
        }

        function loadPestAlerts(weatherData) {
            const humidity = weatherData.main.humidity;
            const temp = weatherData.main.temp;
            
            let pestHtml = '<div style="margin-bottom: 1rem;"><h3>🐛 Current Pest & Disease Risks</h3></div>';
            
            if (humidity > 75 && temp > 25) {
                pestHtml += `
                    <div class="alert">
                        <strong>⚠️ High Risk: Fungal Diseases</strong><br>
                        • Conditions favorable for powdery mildew and rust<br>
                        • Apply neem oil or sulfur-based fungicide weekly<br>
                        • Improve air circulation around plants
                    </div>
                `;
            }
            
            if (temp > 30 && humidity < 50) {
                pestHtml += `
                    <div class="alert">
                        <strong>⚠️ High Risk: Spider Mites</strong><br>
                        • Hot, dry conditions increase mite activity<br>
                        • Spray plants with water daily to disrupt mites<br>
                        • Apply insecticidal soap or neem oil
                    </div>
                `;
            }
            
            if (!pestHtml.includes('alert')) {
                pestHtml += '<div class="recommendation">No significant pest threats detected. Continue regular monitoring.</div>';
            }
            
            pestHtml += `
                <div class="crop-suggestion" style="margin-top: 1.2rem;">
                    <strong>🛡️ Preventive Measures:</strong><br>
                    • Inspect crops twice weekly for early signs<br>
                    • Encourage beneficial insects (ladybugs, lacewings)<br>
                    • Rotate crops annually to disrupt pest cycles<br>
                    • Remove infected plants immediately
                </div>
            `;
            
            document.getElementById('pestAlerts').innerHTML = pestHtml;
        }

        function getWeatherIcon(weather) {
            const icons = {
                'Clear': '☀️',
                'Clouds': '☁️',
                'Rain': '🌧️',
                'Drizzle': '🌦️',
                'Thunderstorm': '⛈️',
                'Snow': '🌨️',
                'Mist': '🌫️',
                'Fog': '🌫️',
                'Haze': '🌫️',
                'Smoke': '💨',
                'Dust': '🌪️',
                'Sand': '🌪️',
                'Tornado': '🌪️'
            };
            return icons[weather] || '🌤️';
        }

        function getAQICategory(aqi) {
            if (aqi <= 50) return { class: 'good', label: 'Good (अच्छा)' };
            if (aqi <= 100) return { class: 'moderate', label: 'Moderate (मध्यम)' };
            if (aqi <= 150) return { class: 'poor', label: 'Unhealthy (हानिकारक)' };
            return { class: 'poor', label: 'Very Unhealthy (बहुत हानिकारक)' };
        }

        function getCurrentSeason() {
            const month = new Date().getMonth() + 1;
            if (month >= 3 && month <= 5) return 'Summer';
            if (month >= 6 && month <= 9) return 'Monsoon';
            if (month >= 10 && month <= 12 || month <= 2) return 'Winter';
            return 'Spring';
        }

        function updateMarketPrices() {
            const crops = [
                { name: 'Wheat (₹/quintal)', price: 2150, trend: 'up' },
                { name: 'Rice (₹/quintal)', price: 1950, trend: 'down' },
                { name: 'Sugarcane (₹/quintal)', price: 380, trend: 'up' },
                { name: 'Cotton (₹/quintal)', price: 5800, trend: 'stable' },
                { name: 'Soybean (₹/quintal)', price: 4200, trend: 'up' },
                { name: 'Maize (₹/quintal)', price: 1850, trend: 'down' }
            ];

            const randomVariation = () => Math.floor(Math.random() * 100) - 50;
            
            const pricesHtml = crops.map(crop => {
                const variation = randomVariation();
                const newPrice = crop.price + variation;
                const trendSymbol = {
                    'up': '↗️',
                    'down': '↘️',
                    'stable': '→'
                }[crop.trend];
                
                const trendClass = crop.trend === 'up' ? '' : crop.trend === 'down' ? 'down' : '';
                
                return `
                    <div class="market-price">
                        <span>${crop.name}</span>
                        <span class="price-trend ${trendClass}">₹${newPrice} ${trendSymbol}</span>
                    </div>
                `;
            }).join('');

            document.getElementById('marketPrices').innerHTML = pricesHtml + 
                '<div style="margin-top: 1rem; font-size: 0.9rem; color: #7f8c8d;">💡 Prices updated every 6 hours | All rates per quintal</div>';
        }

        window.addEventListener('load', () => {
            utils.updateStatus('loading', 'Initializing dashboard...');
            
            updateMarketPrices();
            
            setInterval(() => {
                if (document.getElementById('locationInput').value) {
                    fetchWeatherData();
                }
            }, 1800000); 
            
            setInterval(updateMarketPrices, 300000); 
            
            setTimeout(() => {
                fetchWeatherData();
            }, 1500);
        });

        window.addEventListener('online', () => {
            utils.updateStatus('online', 'Connection restored');
            utils.showNotification("✅ Internet connection restored");
            if (document.getElementById('locationInput').value) {
                fetchWeatherData();
            }
        });

        window.addEventListener('offline', () => {
            utils.updateStatus('offline', 'No internet connection');
            utils.showNotification("⚠️ You are now offline - using cached data");
        });
        
        window.hideNotification = utils.hideNotification;
    </script>
</body>
</html>